#!/bin/sh
mp4=$(mktemp --suffix=.mp4 record.XXXX)

lockfile=/tmp/record

if test -f $lockfile
then
	pid=$(awk '{print $1}' $lockfile)
	if kill -0 $pid
	then
		kill -INT $pid
		echo Killed $(cat $lockfile)
		output=$(awk '{print $2}' $lockfile)
		logger recorded: $(du -h $output)
		upload $output
		rm $lockfile
		exit
	else
		rm $lockfile
	fi
fi

wf-recorder -a -f $mp4 -c h264_vaapi -d /dev/dri/renderD128 &
echo "$! $(readlink -f $mp4)" > $lockfile
