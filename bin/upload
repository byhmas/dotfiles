#!/bin/bash
tmp=$(mktemp -u)
date=$(date --rfc-3339=date)
mkdir -p $tmp/$date
trap "rm -rf $tmp" EXIT

for src in "$@"
do
	if ! test -f "$src"
	then
		echo Missing filename $src >&2
		continue
	fi

	chmod +r "$src"

	if test "${src##*.}" == "png"
	then
		pngquant --ext .png -f "$src"
	fi

	dst=$(basename "$src")

	cp -v "$src" "$tmp/$date/$dst"

	if s3cmd -P put "$tmp/$date/$dst" s3://s.natalian.org/$date/
	then
		logger "http://s.natalian.org/$date/$dst"
		echo "http://s.natalian.org/$date/$dst" | xclip -selection "clipboard" -i
	fi

done

