#!/bin/bash
if ! test -f "$1"
then
	echo Missing filename >&2
	exit 1
fi
s=$1
if test "${s##*.}" == "png"
then
	t=$(mktemp -u).png
	pngcrush -q $s $t
	mv $t $s
fi
t=$(mktemp -u)
d=$(date --rfc-3339=date)
mkdir -p $t/$d
trap "rm -rf $t" EXIT
cp -v $s $t/$d/$(basename $s)
rsync -rv $t/ de:/srv/www/s.natalian.org/ &&
logger http://s.natalian.org/$d/$(basename $s)
